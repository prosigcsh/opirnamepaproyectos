<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dashboard de Megaproyectos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root{
      --bg:#ffffff; --ink:#1f2937; --muted:#6b7280; --brand:#2c3e50;
      --card:#f8fafc; --shadow:0 2px 10px rgba(0,0,0,.08);
    }
    body{font-family:Arial, sans-serif; margin:0; color:var(--ink); background:var(--bg);}
    #header{background:var(--brand); color:#fff; padding:16px 12px; text-align:center; font-size:20px; font-weight:bold;}
    #controls{margin:10px; text-align:center;}
    #controls select{margin:0 6px 6px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; background:#fff;}
    #controls button{padding:8px 14px; background:var(--brand); color:#fff; border:none; cursor:pointer; border-radius:8px; box-shadow:var(--shadow);}
    #map{height:70vh;}
    #legend{
      background:#fff; padding:10px; font-size:12px; line-height:1.5em; border-radius:8px;
      box-shadow:var(--shadow); position:absolute; bottom:98px; left:10px; z-index:1000; max-width:260px;
    }
    .legend-item{margin-bottom:6px; display:flex; align-items:center; gap:6px;}
    .legend-color{width:14px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,.15);}
    #footer{font-size:12px; background:#f4f4f4; padding:12px; text-align:center; border-top:1px solid #e5e7eb;}
    #footer img{height:40px; vertical-align:middle; margin:0 10px;}
    #footer a{color:#0b63c8; text-decoration:none;}
    #notaLegal{font-size:10px; text-align:right; margin:10px 20px; color:#444;}
    .popup-mini{font-size:13px; line-height:1.35;}
    .popup-mini .name{font-weight:bold; display:block; margin-bottom:4px;}
    .popup-mini .tipo{color:var(--muted); margin-bottom:6px; display:block;}
    .popup-mini a{color:#0b63c8; text-decoration:none; font-weight:bold;}
  </style>
</head>
<body>
  <div id="plantillaPDF">
    <div id="header">Megaproyectos y problemáticas socioambientales en México</div>

    <div id="controls">
      <select id="nombreSelect"><option value="">--Nombre--</option></select>
      <select id="tipoSelect"><option value="">--Tipo--</option></select>
      <select id="estadoSelect"><option value="">--Estado--</option></select>
      <button onclick="descargarMapa()">Descargar mapa en PDF</button>
    </div>

    <div id="map"></div>
    <div id="legend"></div>

    <div id="footer">
      <img src="logo-ciesas.png" alt="Logo CIESAS">
      <img src="logotipo-prosig-csh.png" alt="Logo ProSIG-CSH">
      <img src="logotipo-opirna.png" alt="Logo OPIRNA"><br>
      Centro de Investigaciones y Estudios Superiores en Antropología Social (CIESAS) · ProSIG-CSH · OPIRNA<br>
      <a href="https://opirna.ciesas.edu.mx/" target="_blank" rel="noopener">https://opirna.ciesas.edu.mx/</a><br>
      <strong>Elaborado y actualizado por: Carlos Alfredo Hernández Guillén, Vanesa Jaimes López y J. Antonio Bernal Hernández</strong>
    </div>

    <div id="notaLegal">
      Este mapa fue generado con información del OPIRNA del ProSIG-CSH del CIESAS.<br>
      El uso de este material con fines académicos, educativos o informativos está permitido citando la fuente.
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ----- MAPA -----
    const map = L.map('map', { preferCanvas: true }).setView([23.5, -102], 5);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
    const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' });
    L.control.layers({ "Mapa estándar": osm, "Satélite (Esri)": satelite }, null, { position: 'topleft' }).addTo(map);

    // ----- TIPOS (los 16 de tu lista) y COLORES CLAROS Y DISTINTOS -----
    const ordenTipos = [
      "Deforestación",
      "Desarrollo turístico",
      "Energía solar",
      "Eólico",
      "Fracking",
      "Gasoducto",
      "Hidroeléctrico",
      "Infraestructura aeroportuaria / urbana",
      "Infraestructura ferroviaria",
      "Infraestructura hidráulica",
      "Infraestructura marítima",
      "Infraestructura vial",
      "Minería",
      "Producción industrial porcícola",
      "Siderurgia",
      "Termoeléctrica"
    ];

    const colorPorTipo = {
      "Deforestación": "#9BD77A",                     // verde claro
      "Desarrollo turístico": "#FFD166",              // amarillo cálido
      "Energía solar": "#F6D365",                     // ámbar claro
      "Eólico": "#73C2FB",                            // azul cielo
      "Fracking": "#FF9AA2",                          // rosa/rojo suave
      "Gasoducto": "#FAB995",                         // durazno
      "Hidroeléctrico": "#80E1D1",                    // aqua/mint
      "Infraestructura aeroportuaria / urbana": "#BDB2FF", // lavanda
      "Infraestructura ferroviaria": "#A3D3FF",       // azul pastel
      "Infraestructura hidráulica": "#A7F3D0",        // verde menta
      "Infraestructura marítima": "#8ECAE6",          // azul mar
      "Infraestructura vial": "#FBCFE8",              // rosa pastel
      "Minería": "#F5DF8F",                           // amarillo pálido
      "Producción industrial porcícola": "#C6F1A2",   // lima claro
      "Siderurgia": "#D1D5DB",                        // gris claro
      "Termoeléctrica": "#F7B2A1"                     // salmón
    };

    // Normaliza nombres antiguos del GeoJSON a los 16 tipos actuales
    function normalizarTipo(tRaw){
      const t = (tRaw || "").trim();
      const m = {
        "Parque Eólico": "Eólico",
        "Energía solar (megaproyecto)": "Energía solar",
        "Exportación de gas natural licuado (GNL)": "Infraestructura marítima",
        "Industrial / Portuario": "Infraestructura marítima",
        "Infraestructura aeroportuaria/urbana": "Infraestructura aeroportuaria / urbana",
        "Infraestructura aeroportuaria": "Infraestructura aeroportuaria / urbana",
      };
      return m[t] || t;
    }

    const legend = document.getElementById('legend');
    let proyectoLayer, proyectos = [];

    // ----- CARGA DEL GEOJSON -----
    fetch('megaproyectos2.geojson')
      .then(res => res.json())
      .then(data => {
        proyectos = (data.features || []).map(f => {
          f._tipoNorm = normalizarTipo(f.properties?.Tipo);
          return f;
        });

        // Poblar selects con datos normalizados
        const nombres = new Set(), tipos = new Set(), estados = new Set();
        proyectos.forEach(f => {
          const p = f.properties || {};
          if (p.Nombre) nombres.add(p.Nombre);
          if (f._tipoNorm) tipos.add(f._tipoNorm);
          if (p.Estado) estados.add(p.Estado);
        });

        [...nombres].sort().forEach(v => addOption('nombreSelect', v));
        // Mostrar tipos en el orden definido por "ordenTipos"
        ordenTipos.forEach(t => { if (tipos.has(t)) addOption('tipoSelect', t); });
        [...estados].sort().forEach(v => addOption('estadoSelect', v));

        generarLeyenda(ordenTipos.filter(t => tipos.has(t)));
        mostrarProyectos(proyectos);
      })
      .catch(err => console.error('Error al cargar el GeoJSON:', err));

    // ----- UI helpers -----
    function addOption(selectId, value){
      const o = document.createElement('option');
      o.value = value; o.textContent = value;
      document.getElementById(selectId).appendChild(o);
    }

    function generarLeyenda(tiposPresentes){
      legend.innerHTML = '<strong>Leyenda</strong><br>';
      ordenTipos.forEach(tipo => {
        const color = tiposPresentes.includes(tipo) ? colorPorTipo[tipo] : '#f3f4f6';
        const div = document.createElement('div');
        div.className = 'legend-item';
        div.innerHTML = `<span class="legend-color" style="background:${color}"></span>${tipo}`;
        legend.appendChild(div);
      });
    }

    function popupMinimo(p, tipoN){
      return `
        <div class="popup-mini">
          <span class="name">${p.Nombre || 'Sin nombre'}</span>
          <span class="tipo">Tipo: ${tipoN || 'N/D'}</span>
          <a href="#" class="ver-meta">Ver metadatos</a>
        </div>`;
    }

    function mostrarProyectos(lista){
      if(proyectoLayer) proyectoLayer.remove();

      proyectoLayer = L.geoJSON(lista, {
        pointToLayer: (feature, latlng) => {
          const tipoN = feature._tipoNorm || '';
          return L.circleMarker(latlng, {
            radius: 7,
            fillColor: colorPorTipo[tipoN] || '#e5e7eb',
            color: '#111827',
            weight: 0.6,
            opacity: 1,
            fillOpacity: 0.9
          });
        },
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          const tipoN = feature._tipoNorm || p.Tipo || '';
          layer.bindPopup(popupMinimo(p, tipoN));
          layer.on('popupopen', (e) => {
            const link = e.popup.getElement().querySelector('.ver-meta');
            if(link){
              link.addEventListener('click', (ev) => {
                ev.preventDefault();
                abrirMetadatos(p, tipoN);
              });
            }
          });
        }
      }).addTo(map);

      if(lista.length && proyectoLayer.getLayers().length){
        map.fitBounds(proyectoLayer.getBounds().pad(0.1));
      }
    }

    function filtrarProyectos(){
      const nombre = document.getElementById('nombreSelect').value;
      const tipo = document.getElementById('tipoSelect').value;      // ya normalizado
      const estado = document.getElementById('estadoSelect').value;

      const filtrados = proyectos.filter(f => {
        const p = f.properties || {};
        return (!nombre || p.Nombre === nombre) &&
               (!tipo || f._tipoNorm === tipo) &&
               (!estado || p.Estado === estado);
      });
      mostrarProyectos(filtrados);
    }
    document.getElementById('nombreSelect').addEventListener('change', filtrarProyectos);
    document.getElementById('tipoSelect').addEventListener('change', filtrarProyectos);
    document.getElementById('estadoSelect').addEventListener('change', filtrarProyectos);

    // ----- METADATOS (nueva pestaña) -----
    function abrirMetadatos(p, tipoN){
      const safe = (v)=> (v===null||v===undefined||v==="") ? "—" : String(v);
      const entries = Object.keys(p).sort().map(k => {
        const v = p[k];
        const val = (typeof v === 'string' && /^https?:\/\//i.test(v))
          ? `<a href="${v}" target="_blank" rel="noopener">${v}</a>` : safe(v);
        return `<div class="row"><div class="k">${k}</div><div class="v">${val}</div></div>`;
      }).join("");

      const html = `
      <html lang="es">
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Metadatos · ${safe(p.Nombre)}</title>
          <style>
            :root{--bg:#f8fafc;--card:#fff;--ink:#0f172a;--muted:#475569;--brand:#2c3e50;}
            body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--ink);}
            header{background:var(--brand);color:#fff;padding:14px 16px;font-weight:bold;}
            main{max-width:900px;margin:24px auto;padding:0 12px;}
            .card{background:var(--card);border-radius:14px;box-shadow:0 5px 20px rgba(0,0,0,.1);padding:18px;}
            .title{font-size:20px;margin:0 0 6px;}
            .subtitle{color:var(--muted);margin:0 0 16px;}
            .row{display:grid;grid-template-columns:220px 1fr;gap:10px;padding:10px 0;border-bottom:1px solid #e5e7eb;}
            .k{font-weight:bold;color:#374151;}
            .v a{color:#0b63c8;text-decoration:none;word-break:break-all;}
            footer{font-size:12px;color:#64748b;text-align:center;margin:18px 0;}
          </style>
        </head>
        <body>
          <header>Metadatos del proyecto</header>
          <main>
            <div class="card">
              <h1 class="title">${safe(p.Nombre)}</h1>
              <p class="subtitle">Tipo: <strong>${safe(tipoN)}</strong>${p.Estado ? " · Estado: "+safe(p.Estado) : ""}</p>
              ${entries}
            </div>
            <footer>Fuente: OPIRNA · ProSIG-CSH · CIESAS</footer>
          </main>
        </body>
      </html>`;
      const w = window.open('', '_blank');
      w.document.open(); w.document.write(html); w.document.close();
    }

    // ----- Exportar a PDF -----
    function descargarMapa(){
      const contenedor = document.getElementById('plantillaPDF');
      map.invalidateSize();
      html2canvas(contenedor, { useCORS:true, allowTaint:true, scale:2 }).then(canvas => {
        const pdf = new jspdf.jsPDF('landscape', 'pt', [canvas.width, canvas.height]);
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save('mapa_megaproyectos.pdf');
      });
    }
  </script>
</body>
</html>
